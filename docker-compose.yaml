services:
  client:
    env_file:
      - ./client/.env
    build: ./client
    depends_on:
      - boundary
    volumes:
      - ./client:/app

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"

  boundary:
    build:
      context: ./server
      dockerfile: boundary/Dockerfile
    env_file:
      - ./server/boundary/.env
    environment:
      - MOVIES_ROUTER_QUEUE=boundary_movies_router
      - CREDITS_ROUTER_QUEUE=boundary_credits_router
      - RATINGS_ROUTER_QUEUE=boundary_ratings_router
    depends_on:
      - rabbitmq
    ports:
      - "5000:5000"
    volumes:
      - ./server/boundary:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common



# ---------------- START OF BOUNDARY ROUTERS ----------------

  year_movies_router:
    build:
      context: ./server
      dockerfile: router/Dockerfile
    env_file:
      - ./server/router/.env
    environment:
      - NUMBER_OF_PRODUCER_WORKERS=1
      - INPUT_QUEUE=boundary_movies_router
      - OUTPUT_QUEUES=filter_by_year_worker_1,filter_by_year_worker_2
      - BALANCER_TYPE=round_robin
    depends_on:
      - rabbitmq
    volumes:
      - ./server/router:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common

  join_credits_router:
    build:
      context: ./server
      dockerfile: router/Dockerfile
    env_file:
      - ./server/router/.env
    environment:
      - NUMBER_OF_PRODUCER_WORKERS=1
      - INPUT_QUEUE=boundary_credits_router
      # - OUTPUT_QUEUES=join_credits_worker_1_credits,join_credits_worker_2_credits
      - OUTPUT_QUEUES=join_credits_worker_1_credits
      - BALANCER_TYPE=hash_function
    depends_on:
      - rabbitmq
    volumes:
      - ./server/router:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common
      

# ---------------- END OF BOUNDARY ROUTERS ----------------





    
  join_credits_worker_1:
    build:
      context: ./server
      dockerfile: worker/join_credits/Dockerfile
    env_file:
      - ./server/worker/join_credits/.env
    environment:
      - ROUTER_CONSUME_QUEUE_MOVIES=join_credits_worker_1_movies
      - ROUTER_CONSUME_QUEUE_CREDITS=join_credits_worker_1_credits
      - ROUTER_PRODUCER_QUEUE=TODO_ROUTER_COUNT
    depends_on:
      - rabbitmq
    volumes:
      - ./server/worker/join_credits:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common


  filter_by_year_worker_1:
    build:
      context: ./server
      dockerfile: worker/filter_by_year/Dockerfile
    env_file:
      - ./server/worker/filter_by_year/.env
    environment:
      - ROUTER_CONSUME_QUEUE=filter_by_year_worker_1
      - ROUTER_PRODUCER_QUEUE=country_router
    depends_on:
      - rabbitmq
    volumes:
      - ./server/worker/filter_by_year:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common

  filter_by_year_worker_2:
    build:
      context: ./server
      dockerfile: worker/filter_by_year/Dockerfile
    env_file:
      - ./server/worker/filter_by_year/.env
    environment:
      - ROUTER_CONSUME_QUEUE=filter_by_year_worker_2
      - ROUTER_PRODUCER_QUEUE=country_router
    depends_on:
      - rabbitmq
    volumes:
      - ./server/worker/filter_by_year:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common

  country_router:
    build:
      context: ./server
      dockerfile: router/Dockerfile
    env_file:
      - ./server/router/.env
    environment:
      - NUMBER_OF_PRODUCER_WORKERS=2
      - INPUT_QUEUE=country_router
      - OUTPUT_QUEUES=filter_by_country_worker_1,filter_by_country_worker_2
      - BALANCER_TYPE=round_robin
    depends_on:
      - rabbitmq
    volumes:
      - ./server/router:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common
    
  filter_by_country_worker_1:
    build:
      context: ./server
      dockerfile: worker/filter_by_country/Dockerfile
    env_file:
      - ./server/worker/filter_by_country/.env
    environment:
      - ROUTER_CONSUME_QUEUE=filter_by_country_worker_1
      - ROUTER_PRODUCER_QUEUE=join_movies_credits_router
    depends_on:
      - rabbitmq
    volumes:
      - ./server/worker/filter_by_country:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common

  filter_by_country_worker_2:
    build:
      context: ./server
      dockerfile: worker/filter_by_country/Dockerfile
    env_file:
      - ./server/worker/filter_by_country/.env
    environment:
      - ROUTER_CONSUME_QUEUE=filter_by_country_worker_2
      - ROUTER_PRODUCER_QUEUE=join_movies_credits_router
    depends_on:
      - rabbitmq
    volumes:
      - ./server/worker/filter_by_country:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common


  join_movies_credits_router:
    build:
      context: ./server
      dockerfile: router/Dockerfile
    env_file:
      - ./server/router/.env
    environment:
      - NUMBER_OF_PRODUCER_WORKERS=2
      - INPUT_QUEUE=join_movies_credits_router
      # - OUTPUT_QUEUES=join_credits_worker_1_movies,join_credits_worker_2_movies
      - OUTPUT_QUEUES=join_credits_worker_1_movies
      - BALANCER_TYPE=hash_function
    depends_on:
      - rabbitmq
    volumes:
      - ./server/router:/app
      - ./server/rabbitmq:/app/rabbitmq
      - ./server/common:/app/common
